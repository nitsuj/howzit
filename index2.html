<section id="shop">
  <h2>Shop</h2>
  <div id="product-list"></div>
</section>

<script>
  async function fetchSkaterTee() {
    try {
      const response = await fetch('/.netlify/functions/get-skater-tee');
      if (!response.ok) {
        throw new Error('Failed to fetch Skater Tee');
      }

      const product = await response.json();
      const productListEl = document.getElementById('product-list');

      // Group variations by color
      const variationsByColor = product.variations.reduce((acc, variation) => {
        if (!acc[variation.color]) {
          acc[variation.color] = [];
        }
        acc[variation.color].push(variation);
        return acc;
      }, {});

      // Render product
      const productEl = document.createElement('div');
      productEl.className = 'product';

      productEl.innerHTML = `
        <img src="${product.image}" alt="${product.name}" />
        <h3>${product.name}</h3>
      `;

      Object.keys(variationsByColor).forEach(color => {
        const colorGroup = document.createElement('div');
        colorGroup.className = 'color-group';
        colorGroup.innerHTML = `<h4>${color}</h4>`;

        const sizeDropdown = document.createElement('select');
        sizeDropdown.className = 'size-dropdown';

        variationsByColor[color].forEach(variation => {
          const option = document.createElement('option');
          option.value = variation.id;
          option.textContent = `${variation.size} - $${variation.price.toFixed(2)} ${
            variation.available ? '' : '(Out of Stock)'
          }`;
          option.disabled = !variation.available;
          sizeDropdown.appendChild(option);
        });

        const addToCartButton = document.createElement('button');
        addToCartButton.textContent = 'Add to Cart';
        addToCartButton.onclick = () => {
          const selectedVariationId = sizeDropdown.value;
          const selectedVariation = product.variations.find(v => v.id === selectedVariationId);
          if (selectedVariation) {
            addToCart(product.name, selectedVariation.price, selectedVariation.size);
          }
        };

        colorGroup.appendChild(sizeDropdown);
        colorGroup.appendChild(addToCartButton);
        productEl.appendChild(colorGroup);
      });

      productListEl.appendChild(productEl);
    } catch (error) {
      console.error('Error loading Skater Tee:', error);
    }
  }

  function addToCart(name, price, size) {
    console.log(`Adding to cart: ${name}, Size: ${size}, $${price}`);
    const existingItem = cart.find(item => item.name === name && item.size === size);
    if (existingItem) {
      existingItem.quantity += 1;
    } else {
      cart.push({ name, price, size, quantity: 1 });
    }
    renderCart();
  }

  fetchSkaterTee();
</script>
